<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<!-- ==== 대부분은 namespace에 파일이름 사용(유일하니까) ==== -->
<mapper namespace="yuri">

<!-- #### 중요 #### 
		HashMap 타입으로 매개변수를 받아온 것을 꺼내서 사용할 때
		1. 데이터로 사용할 때는 #{key명} 이고, 
		2. 식별자(테이블명, 컬럼명)로 사용할때는 ${key명} 이고, 
		3. myBatis 에서 제공하는 if 엘리먼트나 choose 엘리먼트 안에서 사용할때는
		그냥 <if test="key명"> <when test="key명"> 으로 사용한다. -->
	
	<!-- 전자결재 양식선택(업무기안서, 휴가신청서 등..)을 위한 것 -->
<!-- 	<select id="getApprsortList" resultType="String">
		SELECT appr_name
		FROM tbl_appr a
		LEFT OUTER JOIN tbl_appr_sort s
		ON a.fk_appr_sortno = s.pk_appr_sortno
		WHERE pk_appr_sortno = 9
	</select> -->

	<!-- 파일첨부가 없는 전자결재 문서작성 --> 
	<insert id="edmsAdd" parameterType="com.spring.bts.yuri.model.ApprVO">
		INSERT INTO
		tbl_appr(pk_appr_no, fk_appr_sortno, fk_emp_no, fk_mid_empno, fk_fin_empno, emergency,
		         title, contents,
		         status, mid_accept, fin_accept,
		         mid_opinion, fin_opinion, 
		         writeday, viewcnt)
		VALUES(seq_apprno.nextval, #{fk_appr_sortno}, #{fk_emp_no}, #{fk_mid_empno}, #{fk_fin_empno}, #{emergency},
		       #{title}, #{contents},
		       default, default, default,
		       null, null,
		       default, default)
	</insert>


	<!-- 파일첨부가 있는 전자결재 문서작성 --> 
	<insert id="edmsAdd_withFile" parameterType="com.spring.bts.yuri.model.ApprVO">
		INSERT INTO
		tbl_appr(   pk_appr_no, fk_appr_sortno, fk_emp_no, fk_mid_empno, fk_fin_empno, emergency,
		            title, contents,
		            filename, orgfilename, fileSize,
		            status, mid_accept, fin_accept,
		            mid_opinion, fin_opinion, 
		            writeday, viewcnt)
		VALUES(     seq_apprno.nextval, #{fk_appr_sortno}, #{fk_emp_no}, #{fk_mid_empno}, #{fk_fin_empno}, #{emergency}, 
		            #{title}, #{contents},
		            #{filename}, #{orgfilename}, #{fileSize},
		            default, default, default,
		            null, null,
		            default, default)
	</insert>


<!-- 
////////////////////////////
//***** 대기문서 시작 ***** /////////////////////////////////////////
//////////////////////////
-->

	<!-- 페이징 처리를 안한 검색어가 없는 전체 대기문서 목록 보여주기 -->
	<select id="waitListNoSearch" resultType="com.spring.bts.yuri.model.ApprVO">
		select A.fk_emp_no, A.writeday, S.appr_name, A.emergency, A.title, NVL(A.filename,'파일없음'), A.pk_appr_no, a.status
		from tbl_appr A left join tbl_appr_sort S
		on A.fk_appr_sortno = S.pk_appr_sortno
		order by pk_appr_no desc
	</select>


	<!-- 파일첨부가 있는 대기문서 1개 조회하기 -->
	<select id="getView" parameterType="HashMap" resultType="com.spring.bts.yuri.model.ApprVO">
		SELECT  previousseq, previoussubject
		      , pk_appr_no, fk_appr_sortno, fk_emp_no, fk_mid_empno, fk_fin_empno, emergency
		      , title, CONTENTS, filename, orgfilename, filesize, status, mid_accept, fin_accept
		      , mid_opinion, fin_opinion, writeday, viewcnt
		      , nextseq, nextsubject
		from
		(
		    select  lag(pk_appr_no,1) over(order by pk_appr_no desc)  as previousseq
		          , lag(title,1) over(order by pk_appr_no desc) as previoussubject
		          , pk_appr_no, fk_appr_sortno, fk_emp_no, NVL(fk_mid_empno, -1) AS fk_mid_empno, fk_fin_empno, emergency
		          , title, CONTENTS, filename, orgfilename, filesize, status, NVL(mid_accept, -1) AS mid_accept, fin_accept
		          , NVL(mid_opinion, '중간결재자의견없음') AS mid_opinion, fin_opinion, to_char(writeday, 'yyyy-mm-dd hh24:mi:ss') as writeday, viewcnt
		          , lead(pk_appr_no,1) over(order by pk_appr_no desc) as nextseq
		          , lead(title,1) over(order by pk_appr_no desc) as nextsubject
		    from tbl_appr
		    where status = 0
		) V
	</select>


	<!-- 글조회수 1개 증가시키기 메소드 -->
	<update id="setAddReadCount" parameterType="String">
		update tbl_appr set viewcnt = viewcnt + 1
		where pk_appr_no = #{pk_appr_no}
	</update>
<!-- 
////////////////////////////
//***** 대기문서 종료 ***** /////////////////////////////////////////
//////////////////////////
-->


</mapper>