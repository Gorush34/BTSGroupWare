<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<!-- ==== 대부분은 user_namespace에 파일이름 사용(유일하니까) ==== -->
<mapper namespace="moongil">

<!-- 게시판 목록 -->
    <select id="boardList" resultType="com.spring.bts.moongil.model.BoardVO">
    
	  select pk_seq, fk_emp_no, user_name, subject, content  
		     , read_count, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') as write_day
		     , comment_count
		from tbl_board
		where status = 1
		order by pk_seq desc
    
    </select>

	<!-- === #117. 총 게시물 건수(totalCount) 구하기 - 검색이 있을때 와 검색이 없을때로 나뉜다. === -->
    <select id="getTotalCount" parameterType="HashMap" resultType="int">
	    select count(*)
		from tbl_board
		where status = 1
		<if test='searchType != ""'>
		and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
		</if>
    </select> 

	<select id="boardListSearchWithPaging" parameterType="HashMap" resultType="com.spring.bts.moongil.model.BoardVO">
		select pk_seq, fk_emp_no, user_name, subject, read_count, write_day, comment_count, content,
		       groupno, fk_seq, depthno,
		       filename, ko_rankname
		from
		(
		    select rownum AS rno,
		           pk_seq, fk_emp_no, user_name, subject, read_count, write_day, comment_count, content,
		           groupno, fk_seq, depthno,
		           filename, ko_rankname
		        from
		        (
		            select B.pk_seq AS pk_seq, B.fk_emp_no AS fk_emp_no, B.user_name AS user_name, B.subject AS subject, B.read_count AS read_count, B.content AS content,
		                   to_char(B.write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day, 
		                   B.comment_count AS comment_count,
		                   B.groupno AS groupno, B.fk_seq AS fk_seq, B.depthno AS depthno, 
		                   B.filename AS filename,
		          		   S.ko_rankname AS ko_rankname
		            from tbl_board B join tbl_employees E
                    ON B.user_name = E.emp_name
                    join tbl_rank_sort S
                    ON E.FK_RANK_ID = S.PK_RANK_NO
		            where status = 1
		            <if test='searchType !="" and searchWord != "" '>
		            and lower(${searchType}) like '%'||lower(#{searchWord}) ||'%'
		            </if>
		            start with fk_seq = 0
		            connect by prior pk_seq = fk_seq
		            order siblings by groupno desc, pk_seq asc 
		        ) V
	     )T
		 where rno between #{startRno} and #{endRno}
		 
	</select>

	<select id="boardListNoSearch" resultType="com.spring.bts.moongil.model.BoardVO">
	    select pk_seq, fk_emp_no, user_name, subject  
		     , read_count, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') as write_day
		     , comment_count
		from tbl_board
		where status = 1
		order by pk_seq desc
    </select>
    
        <!-- ==== #161. (댓글 및 답변글쓰기 및 파일첨부가 있는 게시판에서) 글1개 조회하기 ==== 
                         먼저 위의 #140 을 주석처리 한 다음에 아래와 같이 한다.
    -->
    <select id="getView" parameterType="HashMap" resultType="com.spring.bts.moongil.model.BoardVO">
		select previousseq, previoussubject
		     , pk_seq, fk_emp_no, user_name, subject, content, read_count, write_day, pw 
		     , nextseq, nextsubject 
		     , groupno, fk_seq, depthno, like_cnt
		     , filename, org_Filename, file_size, comment_count, ko_rankname
		from 
		(
		    select lag(pk_seq,1) over(order by pk_seq desc) AS previousseq 
		         , lag(subject,1) over(order by pk_seq desc) AS previoussubject  
		         , pk_seq, fk_emp_no, user_name, subject, content, read_count
		         , to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') as write_day
		         , pw, like_cnt 	         
		         , lead(pk_seq,1) over(order by pk_seq desc) AS nextseq
		         , lead(subject,1) over(order by pk_seq desc) AS nextsubject         
		         , groupno, fk_seq, depthno
		         , filename, org_Filename, file_size, comment_count,
		            S.ko_rankname AS ko_rankname
		            from tbl_board B join tbl_employees E
                    ON B.user_name = E.emp_name
                    join tbl_rank_sort S
                    ON E.FK_RANK_ID = S.PK_RANK_NO
		    where status = 1
		    <if test='searchType != "" and searchWord != "" '>
		    and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
		    </if>
		) V
		where V.pk_seq = #{pk_seq}
    </select>
    
    <!-- ==== #67. 글조회수 1증가 하기 ==== -->
    <update id="setAddread_count" parameterType="String">
    	update tbl_board set read_count = read_count + 1
    	where pk_seq = #{pk_seq}
    </update>
    
    
    
	<!-- === #146. tbl_board 테이블에서  groupno 컬럼의 최대값 알아오기 === -->
	<select id="getGroupnoMax" resultType="int">
		select nvl(max(groupno), 0)
		from tbl_board
	</select>    
    
    <!--  ==== #147. 원글쓰기 또는 답변글쓰기(파일첨부가 없는 글쓰기) ==== -->
	<insert id="add" parameterType="com.spring.bts.moongil.model.BoardVO">
		<if test='fk_seq.equals("")'>
		     insert into tbl_board(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno)
		     values(boardseq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, default, default)   
		</if>
		<!-- 답글 -->
		 <if test='!fk_seq.equals("")'>
		     insert into tbl_board(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno)
		     values(boardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, #{fk_seq}, #{depthno}+1)   
		</if>     
	</insert>
    
    
    <!-- === #158. 글쓰기(첨부파일이 있는 경우) ===  -->
	<insert id="add_withFile" parameterType="com.spring.bts.moongil.model.BoardVO" >
		<if test='fk_seq.equals("")'>
		     insert into tbl_board(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, filename, org_filename, file_size)
		     values(boardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, default, default, #{filename}, #{org_filename}, #{file_size})   
	     </if>
	     <!-- 답글 -->
	     <if test='!fk_seq.equals("")'>
		     insert into tbl_board(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, filename, org_filename, file_size)
		     values(boardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, #{fk_seq}, #{depthno}+1, #{filename}, #{org_filename}, #{file_size})    
	     </if>
	</insert>
    
    
    <update id="del" parameterType="HashMap">
    	update tbl_board set status = 0
    	where pk_seq = #{pk_seq}
    </update>
    
    <!-- 조회수 증가 -->
    <update id="setAddReadCount" parameterType="String">
    	update tbl_board set read_count = read_count + 1
    	where pk_seq = #{pk_seq}
    </update>
    
    <!-- ==== #75. 1개글 수정하기 ==== -->
    <update id="edit" parameterType="com.spring.bts.moongil.model.BoardVO">
	    update tbl_board set subject = #{subject}
		                   , content = #{content}
		where pk_seq = #{pk_seq} and pw = #{pw}
    </update>
    
    <!-- ==== 임시저장 (파일없는) ==== -->
	<insert id="save" parameterType="com.spring.bts.moongil.model.BoardVO">
		<if test='fk_seq.equals("")'>
		     insert into tbl_board(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno)
		     values(temp_boardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, 2, #{groupno}, default, default)   
		</if>
		<!-- 답글 -->
		 <if test='!fk_seq.equals("")'>
		     insert into tbl_board(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno)
		     values(temp_boardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, 2, #{groupno}, #{fk_seq}, #{depthno}+1)   
		</if>     
	</insert>

	<!-- 임시 저장(첨부파일이 있는 경우) ===  -->
	<insert id="save_withFile" parameterType="com.spring.bts.moongil.model.BoardVO" >
		<if test='fk_seq.equals("")'>
		     insert into tbl_board(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, filename, org_filename, file_size)
		     values(temp_boardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, 2, #{groupno}, default, default, #{filename}, #{org_filename}, #{file_size})   
	     </if>
	     <!-- 답글 -->
	     <if test='!fk_seq.equals("")'>
		     insert into tbl_board(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, filename, org_filename, file_size)
		     values(temp_boardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, 2, #{groupno}, #{fk_seq}, #{depthno}+1, #{filename}, #{org_filename}, #{file_size})    
	     </if>
	</insert>

	<!-- ==== 임시저장글 작성완료  ==== -->
    <update id="tmp_write" parameterType="com.spring.bts.moongil.model.BoardVO">
	    update tbl_board set subject = #{subject}
		                   , content = #{content}
		                   , write_day = default
		                   , pw = #{pw}
		                   , status = 1
		                   , pk_seq = boardSeq.nextval
		where pk_seq = #{pk_seq}
    </update>
	

	<select id="exist" parameterType="HashMap" resultType="int">
	    select count (*)
		from tbl_board
		where status = 2 and fk_emp_no = #{fk_emp_no}
    </select>
    
    <!-- 임시 작성글 조회 -->
    <select id="temp_list" resultType="com.spring.bts.moongil.model.BoardVO">
    
	  select subject, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') as write_day, pk_seq
		from tbl_board
		where status = 2 and fk_emp_no = #{fk_emp_no}
		order by write_day desc
    
    </select>
    
    
    <select id="getView2" parameterType="HashMap" resultType="com.spring.bts.moongil.model.BoardVO">
		select pk_seq, fk_emp_no, user_name, subject, content, read_count, write_day, pw 
		     , groupno, fk_seq, depthno, filename, org_Filename, file_size, comment_count
		from 
		(
		    select pk_seq, fk_emp_no, user_name, subject, content, read_count
		         , to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') as write_day
		         , pw, groupno, fk_seq, depthno, filename, org_Filename, file_size, comment_count
		    from tbl_board
		    where status = 2
		) V
		where V.pk_seq = #{pk_seq}
    </select>
    
        <!-- #88. 댓글쓰기(tbl_comment 테이블에 insert) === -->
    <insert id="addComment" parameterType="com.spring.bts.moongil.model.CommentVO">
	        insert into tbl_comment(pk_seq, fk_emp_no, name, content, regDate, fk_seq, status) 
	        values(commentSeq.nextval, #{fk_emp_no}, #{name}, #{content}, default, #{fk_seq}, default)
    </insert>
    
    <!--  === #89.-1  tbl_board 테이블에 commentCount 컬럼의 값을 1증가(update) === -->  
	<update id="updateCommentCount" parameterType="String">
    	update tbl_board set comment_count = comment_count + 1 
    	where pk_seq = #{fk_seq}
    </update>
    
    <!-- === #93. 원게시물에 딸린 댓글들을 조회해오기 === -->  
    <select id="getCommentList" parameterType="String" resultType="com.spring.bts.moongil.model.CommentVO"> 
	    select name, content, to_char(regDate, 'yyyy-mm-dd hh24:mi') AS regDate 
		from tbl_comment
		where status = 1 and fk_seq = #{fk_seq}
		order by pk_seq asc
    </select>
    
   
    
    <!-- === #135. 원글 글번호(parentSeq) 여기에 해당하는 댓글 totalPage 수 알아오기 === -->
	<select id="getCommentTotalPage" parameterType="HashMap" resultType="int">
		select ceil(count(*)/#{sizePerPage})
		from tbl_comment
		where status = 1 and fk_seq = #{fk_seq}
	</select>
    
    
    <select id="getCommentListPaging" parameterType="HashMap" resultType="com.spring.bts.moongil.model.CommentVO">

		select name, content, regDate, fk_emp_no, pk_seq, fk_seq
		from 
		(
		select row_number() over(order by pk_seq desc) AS rno, name, content, fk_emp_no, pk_seq, fk_seq, to_char(regDate, 'yyyy-mm-dd hh24:mi:ss') AS regDate
		from tbl_comment
		where status = 1 and fk_seq = #{fk_seq}
		) V
		where rno between #{startRno} and #{endRno}
	</select>	
	
	<update id="delComment" parameterType="String">
		update tbl_comment set status = 0
		where pk_seq = #{pk_seq}
	</update>
	

	<update id="minusCommentCount" parameterType="String">
    	update tbl_board set comment_count = comment_count - 1 
    	where pk_seq = #{fk_seq}
    </update>
	
	
	<!-- ====================================공지사항시작=================================================== -->
	
	<select id="noticeListSearchWithPaging" parameterType="HashMap" resultType="com.spring.bts.moongil.model.NoticeVO">
		select pk_seq, fk_emp_no, user_name, subject, read_count, write_day, content,
		       groupno, fk_seq, depthno, filename, header
		from
		(
		    select rownum AS rno,
		           pk_seq, fk_emp_no, user_name, subject, read_count, write_day, content,
		           groupno, fk_seq, depthno,filename, header
		        from
		        (
		            select pk_seq, fk_emp_no, user_name, subject, read_count, content,
		                   to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day,
		                   groupno, fk_seq, depthno, filename, header
		            from tbl_notice
		            where status = 1
		            <if test='searchType !="" and searchWord != "" '>
		            and lower(${searchType}) like '%'||lower(#{searchWord}) ||'%'
		            </if>
		            <if test='headerCategory != "" and headerCategory != null'>
		            and header = '${headerCategory}'
		            </if>
		            start with fk_seq = 0
		            connect by prior pk_seq = fk_seq
		            order siblings by groupno desc, pk_seq desc 
		        ) V
	     )T
		 where rno between #{startRno} and #{endRno}
		 
	</select>
	
	
	<!-- === 총게시물 건수. === -->
    <select id="getTotalCount_notice" parameterType="HashMap" resultType="int">
	    select count(*)
		from tbl_notice
		where status = 1
		<if test='searchType != ""'>
		and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
		</if>
    </select> 
    
    <select id="temp_list_notice" resultType="com.spring.bts.moongil.model.NoticeVO">
    
	  select subject, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') as write_day, pk_seq
		from tbl_board
		where status = 2 and fk_emp_no = #{fk_emp_no}
		order by write_day desc
    
    </select>
    
     <!--  ==== #147. 원글쓰기 또는 답변글쓰기(파일첨부가 없는 글쓰기) ==== -->
	<insert id="add_notice" parameterType="com.spring.bts.moongil.model.NoticeVO">
		<if test='fk_seq.equals("")'>
		     insert into tbl_notice(pk_seq, header, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno)
		     values(noticeSeq.nextval, #{header}, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, default, default)   
		</if>
		<!-- 답글 -->
		 <if test='!fk_seq.equals("")'>
		     insert into tbl_notice(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, header)
		     values(noticeSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, #{fk_seq}, #{depthno}+1, #{header})   
		</if>     
	</insert>
    
    <!-- === #158. 글쓰기(첨부파일이 있는 경우) ===  -->
	<insert id="add_withFile_notice" parameterType="com.spring.bts.moongil.model.NoticeVO" >
		<if test='fk_seq.equals("")'>
		     insert into tbl_notice(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, header, filename, org_filename, file_size)
		     values(noticeSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, default, default, #{header}, #{filename}, #{org_filename}, #{file_size})   
	     </if>
	     <!-- 답글 -->
	     <if test='!fk_seq.equals("")'>
		     insert into tbl_notice(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, header, filename, org_filename, file_size)
		     values(noticeSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, #{fk_seq}, #{depthno}+1, #{header}, #{filename}, #{org_filename}, #{file_size})    
	     </if>
	</insert>
    
    <!-- 조회수 증가 -->
    <update id="setAddReadCount_notice" parameterType="String">
    	update tbl_notice set read_count = read_count + 1
    	where pk_seq = #{pk_seq}
    </update>
    
     <!-- ==== #161. (댓글 및 답변글쓰기 및 파일첨부가 있는 게시판에서) 글1개 조회하기 ==== 
                         먼저 위의 #140 을 주석처리 한 다음에 아래와 같이 한다.
    -->
    <select id="getView_notice" parameterType="HashMap" resultType="com.spring.bts.moongil.model.NoticeVO">
		select previousseq, previoussubject
		     , pk_seq, fk_emp_no, user_name, subject, content, read_count, write_day, pw, header
		     , nextseq, nextsubject 
		     , groupno, fk_seq, depthno
		     , filename, org_Filename, file_size
		from 
		(
		    select lag(pk_seq,1) over(order by pk_seq desc) AS previousseq 
		         , lag(subject,1) over(order by pk_seq desc) AS previoussubject 
		         
		         , pk_seq, fk_emp_no, user_name, subject, content, read_count
		         , to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') as write_day
		         , pw, header
		         
		         , lead(pk_seq,1) over(order by pk_seq desc) AS nextseq
		         , lead(subject,1) over(order by pk_seq desc) AS nextsubject
		         
		         , groupno, fk_seq, depthno
		         
		         , filename, org_Filename, file_size
		    from tbl_notice
		    where status = 1
		    <if test='searchType != "" and searchWord != "" '>
		    and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
		    </if>
		) V
		where V.pk_seq = #{pk_seq}
    </select>
    
    <!-- ==== #75. 1개글 수정하기 ==== -->
    <update id="edit_notice" parameterType="com.spring.bts.moongil.model.NoticeVO">
	    update tbl_notice set subject = #{subject}
		                   , content = #{content}
		                   , header = #{header}
		where pk_seq = #{pk_seq} and pw = #{pw}
    </update>
   
   <update id="del_notice" parameterType="HashMap">
    	update tbl_notice set status = 0
    	where pk_seq = #{pk_seq}
    </update>
    
 <!--    /////////////////////////////////////////////////////////////////////////////// -->
    
    
    <!-- 게시글 추천수 -->
	<update id="updateLike" parameterType="int">
	update tbl_board set 
	like_cnt = like_cnt+1
	where pk_seq = #{fk_seq}
	</update>
	
	<!-- 게시글 추천수취소 -->
	<update id="updateLikeCancel" parameterType="int">
	update tbl_board set 
	like_cnt = like_cnt - 1
	where pk_seq = #{fk_seq}
	</update>
	
	<!-- 게시글 추천 시 Like 테이블에 insert -->
	<insert id="insertLike">
	insert into tbl_board_like(pk_seq , fk_seq , fk_emp_no) 
	values((SELECT NVL(MAX(pk_seq), 0) + 1 FROM tbl_board_like) ,#{fk_seq} ,#{fk_emp_no})
	</insert>
	
	<!-- 게시글 추천취소 시 delete -->
	<delete id="deleteLike">
	delete from tbl_board_like where fk_seq = #{fk_seq} and fk_emp_no = #{fk_emp_no}
	</delete>
	
	<!-- 게시글 추천 중복방지 select문 -->
	<select id="likeCheck" resultType="int">
	select count(*) from tbl_board_like where fk_seq = #{fk_seq} and fk_emp_no = #{fk_emp_no} 
	</select>
	
	
    <select id="get_heart" parameterType="HashMap" resultType="com.spring.bts.moongil.model.LikeVO">
		    select pk_seq, fk_emp_no, fk_seq, emp_name, ko_ranknam
			from
			(
			select L.pk_seq AS pk_seq, L.fk_emp_no AS fk_emp_no, L.like_date as like_date, L.fk_seq as fk_seq, E.emp_name as emp_name, S.ko_rankname AS ko_ranknam
			from tbl_board_like L
			JOIN tbl_employees E
			ON L.fk_emp_no = E.pk_emp_no
			join tbl_rank_sort S
			ON E.FK_RANK_ID = S.PK_RANK_NO
			) V
		    where fk_seq = #{pk_seq} 

    </select>
    
    
       <!-- 인기 글 목록 불러오기 -->
   <select id="getIntegratedBoard" resultType="com.spring.bts.moongil.model.BoardVO">

      select pk_seq, subject, user_name, write_day, tblname
      from
      (
           select row_number() over(order by write_day desc) AS rno
                 , pk_seq, subject, write_day, tblname, user_name
           from
         (
             select pk_seq, subject, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day, user_name , '일반게시판' AS tblname
             from tbl_board B
             UNION
             select pk_seq, subject, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day, user_name , '전사 공지' AS tblname
             from tbl_notice N
             UNION
             select pk_seq, subject, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day, user_name , '자료실' AS tblname
             from tbl_fileboard F
         ) A
     ) B
      where rno between 1 and 5
   </select>   
    
    
	<select id="getTotalCount_total" parameterType="HashMap" resultType="int">
	        select count(*)
			from
	         (
	             select pk_seq, status, subject
	             from tbl_board B
	             UNION
	             select pk_seq, status, subject
	             from tbl_notice N
	             UNION
	             select pk_seq, status, subject
	             from tbl_fileboard F
	         )
			where status = 1
			<if test='searchType != ""'>
			and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
			</if>
	</select>

	<select id="boardListSearchWithPaging_total" parameterType="HashMap" resultType="com.spring.bts.moongil.model.BoardVO">
	 	 select rno,
			            fk_emp_no, pk_seq, KO_RANKNAME ,subject, write_day, user_name, 
	                    comment_count, filename, read_count, content, depthno, status, tblname
			from
			(
			    select rownum AS rno,
			            fk_emp_no, pk_seq, KO_RANKNAME ,subject, write_day, user_name, 
	                    comment_count, filename, read_count, content, depthno, status, tblname
			        from
	                     (
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day, user_name , comment_count, filename, read_count, content, depthno, status, '자유게시판' AS tblname
	                     from tbl_board B join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO 
	                     UNION   
	                     select fk_emp_no, pk_seq, KO_RANKNAME, subject, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day, user_name , comment_count, filename, read_count, content, depthno, status, '공지사항' AS tblname
	                     from tbl_notice N join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO    
	                     UNION
	                     select fk_emp_no, pk_seq, KO_RANKNAME, subject, to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day, user_name , comment_count, filename, read_count, content, depthno, status, '자료실' AS tblname
	                     from tbl_fileboard F join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO
	                     order by write_day desc 
	                  ) A        
			            where status = 1 and depthno = 0
			            <if test='searchType !="" and searchWord != "" '>
					    and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
					    </if>

			        ) V
		 where rno between #{startRno} and #{endRno}
           
	</select>    

<!--      
<select id="getBestboard" parameterType="HashMap" resultType="com.spring.board.model.BoardVO"> 
  select rno, fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day
			from
			(
			    select rownum AS rno,
			            fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day
			        from
	                     (
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, to_char(write_day, 'yyyy-mm-dd') AS write_day, '일반게시판' AS tblname
	                     from tbl_board B join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO 
	                     UNION   
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, to_char(write_day, 'yyyy-mm-dd') AS write_day, '전사 공지' AS tblname
	                     from tbl_notice N join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO    
	                     UNION
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, to_char(write_day, 'yyyy-mm-dd') AS write_day, '자료실' AS tblname
	                     from tbl_fileboard F join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO
	                  ) A        
			            where write_day = '2022-05-12'
			        ) V
		 where rno between 1 and 5
         order by read_count desc ;
   </select>
  -->
   <resultMap type="HashMap" id="getBestboardMap">
      <result property="pk_seq" column="pk_seq" javaType="String" />
      <result property="subject" column="subject" javaType="String" />
      <result property="read_count" column="read_count" javaType="String" />
      <result property="user_name" column="user_name" javaType="String" />
      <result property="tblname" column="tblname" javaType="String" />
   </resultMap>
   <select id="getBestboard" resultMap="getBestboardMap">
	select rno, fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, tblname
			from
			(
			    select rownum AS rno,
			            fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, tblname
			        from
	                     (
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, '자유게시판' AS tblname
	                     from tbl_board B join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO 
	                    where status = 1 and write_day like '%'|| sysdate ||'%'
	                    UNION   
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, '공지사항' AS tblname
	                     from tbl_notice N join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO   
	                    where status = 1 and write_day like '%'|| sysdate ||'%' 
	                     UNION
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, '자료실' AS tblname
	                     from tbl_fileboard F join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO
                        where status = 1 and write_day like '%'|| sysdate ||'%'
                        order by read_count desc 
	                  ) A        
			        ) V
		 where rno between 1 and 5
		 order by read_count desc 
   </select> 
    
<!--     ////////////////////////////////////////////////////////////////////////////////////////////////// -->
<!-- 자료게시판 -->
	 <select id="ListSearchWithPaging_fileboard" parameterType="HashMap" resultType="com.spring.bts.moongil.model.FileboardVO">
		select pk_seq, fk_emp_no, user_name, subject, read_count, write_day, content,
		       groupno, fk_seq, depthno, filename, ko_depname, ko_rankname
		from
		(
		    select rownum AS rno,
		           pk_seq, fk_emp_no, user_name, subject, read_count, write_day, content,
		           groupno, fk_seq, depthno,filename, ko_depname, ko_rankname
		        from
		        (
		            select pk_seq, fk_emp_no, user_name, subject, read_count, content,
		                   to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') AS write_day,
		                   groupno, fk_seq, depthno, filename, ko_depname, ko_rankname
		            from tbl_fileboard B join tbl_employees E
                    ON B.user_name = E.emp_name
                    join tbl_rank_sort S
                    ON E.FK_RANK_ID = S.PK_RANK_NO
		            where status = 1
		            <if test='searchType !="" and searchWord != "" '>
		            and lower(${searchType}) like '%'||lower(#{searchWord}) ||'%'
		            </if>
		            <if test='ko_depname != "" and ko_depname != null'>
		            and ko_depname = '${ko_depname}'
		            </if>
		            start with fk_seq = 0
		            connect by prior pk_seq = fk_seq
		            order siblings by groupno desc, pk_seq desc 
		        ) V
	     )T
		 where rno between #{startRno} and #{endRno}
		 
	</select>
	 
	
<!-- 	=== 총게시물 건수. === -->
    <select id="getTotalCount_fileboard" parameterType="HashMap" resultType="int">
	    select count(*)
		from tbl_fileboard
		where status = 1
		<if test='searchType != ""'>
		and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
		</if>
    </select> 

 <!--  ==== #147. 원글쓰기 또는 답변글쓰기(파일첨부가 없는 글쓰기) ==== -->
	<insert id="add_fileboard" parameterType="com.spring.bts.moongil.model.FileboardVO">
		<if test='fk_seq.equals("")'>
		     insert into tbl_fileboard(pk_seq, ko_depname, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno)
		     values(fileboardSeq.nextval, #{ko_depname}, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, default, default)   
		</if>
		<!-- 답글 -->
		 <if test='!fk_seq.equals("")'>
		     insert into tbl_fileboard(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, ko_depname)
		     values(fileboardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, #{fk_seq}, #{depthno}+1, #{ko_depname})   
		</if>     
	</insert>     
     
      <!-- === #158. 글쓰기(첨부파일이 있는 경우) ===  -->
	<insert id="add_withFile_fileboard" parameterType="com.spring.bts.moongil.model.FileboardVO" >
		<if test='fk_seq.equals("")'>
		     insert into tbl_fileboard(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, ko_depname, filename, org_filename, file_size)
		     values(fileboardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, default, default, #{ko_depname}, #{filename}, #{org_filename}, #{file_size})   
	     </if>
	     <!-- 답글 -->
	     <if test='!fk_seq.equals("")'>
		     insert into tbl_fileboard(pk_seq, fk_emp_no, user_name, subject, content, pw, read_count, write_day, status, groupno, fk_seq, depthno, ko_depname, filename, org_filename, file_size)
		     values(fileboardSeq.nextval, #{fk_emp_no}, #{user_name}, #{subject}, #{content}, #{pw}, default, default, default, #{groupno}, #{fk_seq}, #{depthno}+1, #{ko_depname}, #{filename}, #{org_filename}, #{file_size})    
	     </if>
	</insert>
     
     
     <!-- 글 조회 -->
    <select id="getView_fileboard" parameterType="HashMap" resultType="com.spring.bts.moongil.model.FileboardVO">
		select previousseq, previoussubject
		     , pk_seq, fk_emp_no, user_name, subject, content, read_count, write_day, pw, ko_depname, ko_rankname
		     , nextseq, nextsubject 
		     , groupno, fk_seq, depthno
		     , filename, org_Filename, file_size
		from 
		(
		    select lag(pk_seq,1) over(order by pk_seq desc) AS previousseq 
		         , lag(subject,1) over(order by pk_seq desc) AS previoussubject 
		         
		         , pk_seq, fk_emp_no, user_name, subject, content, read_count
		         , to_char(write_day, 'yyyy-mm-dd hh24:mi:ss') as write_day
		         , pw, ko_depname, ko_rankname
		         
		         , lead(pk_seq,1) over(order by pk_seq desc) AS nextseq
		         , lead(subject,1) over(order by pk_seq desc) AS nextsubject
		         
		         , groupno, fk_seq, depthno
		         
		         , filename, org_Filename, file_size
		    from tbl_fileboard B join tbl_employees E
             ON B.user_name = E.emp_name
             join tbl_rank_sort S
             ON E.FK_RANK_ID = S.PK_RANK_NO
		    where status = 1
		    <if test='searchType != "" and searchWord != "" '>
		    and lower(${searchType}) like '%'|| lower(#{searchWord}) ||'%'
		    </if>
		) V
		where V.pk_seq = #{pk_seq}
    </select> 
     
     
     <!-- 조회수 증가 -->
    <update id="setAddReadCount_fileboard" parameterType="String">
    	update tbl_fileboard set read_count = read_count + 1
    	where pk_seq = #{pk_seq}
    </update>
    
  <!-- ==== 1개글 수정하기 ==== -->
    <update id="edit_fileboard" parameterType="com.spring.bts.moongil.model.FileboardVO">
	    update tbl_fileboard set subject = #{subject}
		                   , content = #{content}
		                   , ko_depname = #{ko_depname}
		where pk_seq = #{pk_seq} and pw = #{pw}
    </update>
   
   <!-- ==== 1개글 삭제하기 ==== -->
   <update id="del_fileboard" parameterType="HashMap">
    	update tbl_fileboard set status = 0
    	where pk_seq = #{pk_seq}
    </update>    
    
<!-- //////////////////////////////////////////////////////////////////////// -->


     
      <resultMap type="HashMap" id="getNoticeboard">
      <result property="pk_seq" column="pk_seq" javaType="String" />
      <result property="subject" column="subject" javaType="String" />
      <result property="user_name" column="user_name" javaType="String" />
      <result property="write_day" column="write_day" javaType="String" />
      <result property="header" column="header" javaType="String" />
  	  </resultMap>
   <select id="getNoticeboard" resultMap="getNoticeboard">
	select rno, fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, header
			from
			(
			    select rownum AS rno,
			            fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, header
			        from
	                     (
	                     select fk_emp_no, pk_seq, KO_RANKNAME, header, subject, user_name, comment_count, read_count, status, to_char(write_day, 'yyyy-mm-dd') AS write_day
	                     from tbl_notice B join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO 
                        where status = 1 
                      order by pk_seq desc
	                  ) A        
			        ) V
		 where rno between 1 and 5
   </select>  
   
   
   
   <resultMap type="HashMap" id="getBoard">
      <result property="pk_seq" column="pk_seq" javaType="String" />
      <result property="subject" column="subject" javaType="String" />
      <result property="user_name" column="user_name" javaType="String" />
      <result property="write_day" column="write_day" javaType="String" />
      <result property="ko_rankname" column="ko_rankname" javaType="String" />
  </resultMap>
   <select id="getBoard" resultMap="getBoard">
	select rno, fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day
			from
			(
			    select rownum AS rno,
			            fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day
			        from
	                     (
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, to_char(write_day, 'yyyy-mm-dd') AS write_day
	                     from tbl_board B join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO 
                        where status = 1 
                      order by pk_seq desc
	                  ) A        
			        ) V
		 where rno between 1 and 5
   </select> 
   
   
   
   <resultMap type="HashMap" id="getFileboard">
      <result property="pk_seq" column="pk_seq" javaType="String" />
      <result property="subject" column="subject" javaType="String" />
      <result property="user_name" column="user_name" javaType="String" />
      <result property="write_day" column="write_day" javaType="String" />
      <result property="ko_rankname" column="ko_rankname" javaType="String" />
      <result property="ko_depname" column="ko_depname" javaType="String" />
  	  </resultMap>
   <select id="getFileboard" resultMap="getFileboard">
		select rno, fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, ko_depname
			from
			(
			    select rownum AS rno,
			            fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, ko_depname
			        from
	                     (
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, to_char(write_day, 'yyyy-mm-dd') AS write_day, ko_depname
	                     from tbl_fileboard B join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO 
                        where status = 1 
                      order by pk_seq desc
	                  ) A        
			        ) V
		 where rno between 1 and 5
   </select> 
   
   <resultMap type="HashMap" id="getAll">
      <result property="pk_seq" column="pk_seq" javaType="String" />
      <result property="subject" column="subject" javaType="String" />
      <result property="user_name" column="user_name" javaType="String" />
      <result property="write_day" column="write_day" javaType="String" />
      <result property="ko_rankname" column="ko_rankname" javaType="String" />
      <result property="ko_depname" column="ko_depname" javaType="String" />
      <result property="tblname" column="tblname" javaType="String" />
  	  </resultMap>
   <select id="getAll" resultMap="getAll">
	select rno, fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, tblname
			from
			(
			    select rownum AS rno,
			            fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, to_char(write_day, 'yyyy-mm-dd') AS write_day, tblname
			        from
	                     (
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, '자유게시판' AS tblname
	                     from tbl_board B join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO 
	                    where status = 1
	                    UNION   
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, '공지사항' AS tblname
	                     from tbl_notice N join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO   
	                    where status = 1
	                     UNION
	                     select fk_emp_no, pk_seq, KO_RANKNAME , subject, user_name, comment_count, read_count, status, write_day, '자료실' AS tblname
	                     from tbl_fileboard F join tbl_employees E
	                    ON fk_emp_no = E.pk_emp_no
	                    join tbl_rank_sort S
	                    ON E.FK_RANK_ID = S.PK_RANK_NO
                        where status = 1
                        order by write_day desc  
	                  ) A        
			        ) V
		 where rno between 1 and 5
		 order by write_day desc  
   </select> 
     
</mapper>